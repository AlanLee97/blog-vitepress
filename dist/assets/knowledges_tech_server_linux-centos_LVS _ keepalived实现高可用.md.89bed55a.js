import{_ as s,o as a,c as n,b as l}from"./app.d2d47940.js";const F=JSON.parse('{"title":"LVS + keepalived实现高可用","description":"","frontmatter":{},"headers":[{"level":2,"title":"准备资源","slug":"准备资源","link":"#准备资源","children":[]},{"level":2,"title":"操作步骤","slug":"操作步骤","link":"#操作步骤","children":[{"level":3,"title":"DR上操作","slug":"dr上操作","link":"#dr上操作","children":[]},{"level":3,"title":"keepalived节点配置","slug":"keepalived节点配置","link":"#keepalived节点配置","children":[]},{"level":3,"title":"RS上操作","slug":"rs上操作","link":"#rs上操作","children":[]}]},{"level":2,"title":"测试","slug":"测试","link":"#测试","children":[]}],"relativePath":"knowledges/tech/server/linux-centos/LVS + keepalived实现高可用.md","lastUpdated":1678618356000}'),p={name:"knowledges/tech/server/linux-centos/LVS + keepalived实现高可用.md"},o=l(`<h1 id="lvs-keepalived实现高可用" tabindex="-1">LVS + keepalived实现高可用 <a class="header-anchor" href="#lvs-keepalived实现高可用" aria-hidden="true">#</a></h1><p>LVS可以实现负载均衡，但是不能够进行健康检查，比如一个rs出现故障，LVS 仍然会把请求转发给故障的rs服务器，这样就会导致请求的无效性。keepalive 软件可以进行健康检查，而且能同时实现 LVS 的高可用性，解决 LVS 单点故障的问题，其实 keepalive 就是为 LVS 而生的。</p><h2 id="准备资源" tabindex="-1">准备资源 <a class="header-anchor" href="#准备资源" aria-hidden="true">#</a></h2><table><thead><tr><th>主机</th><th>ip</th><th>角色</th></tr></thead><tbody><tr><td>master1</td><td>192.168.1.20</td><td>DR1</td></tr><tr><td>master1</td><td>192.168.1.200</td><td>DR2</td></tr><tr><td>node1</td><td>192.168.1.21</td><td>RS1</td></tr><tr><td>node2</td><td>192.168.1.22</td><td>RS2</td></tr></tbody></table><h2 id="操作步骤" tabindex="-1">操作步骤 <a class="header-anchor" href="#操作步骤" aria-hidden="true">#</a></h2><h3 id="dr上操作" tabindex="-1">DR上操作 <a class="header-anchor" href="#dr上操作" aria-hidden="true">#</a></h3><h4 id="安装keepalived" tabindex="-1">安装keepalived <a class="header-anchor" href="#安装keepalived" aria-hidden="true">#</a></h4><div class="language-sh"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#FFCB6B;">yum</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">install</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">ipvsadm</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">keepalived</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">-y</span></span>
<span class="line"></span></code></pre></div><h3 id="keepalived节点配置" tabindex="-1">keepalived节点配置 <a class="header-anchor" href="#keepalived节点配置" aria-hidden="true">#</a></h3><h4 id="dr1" tabindex="-1">DR1 <a class="header-anchor" href="#dr1" aria-hidden="true">#</a></h4><p>编辑配置文件</p><div class="language-sh"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#FFCB6B;">vim</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">/etc/keepalived/keepalived.conf</span></span>
<span class="line"></span></code></pre></div><p>keepalived.conf</p><div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#89DDFF;">!</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Configuration</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">File</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">for</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">keepalived</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FFCB6B;">global_defs</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">   </span><span style="color:#FFCB6B;">notification_email</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">     </span><span style="color:#FFCB6B;">acassen@firewall.loc</span></span>
<span class="line"><span style="color:#A6ACCD;">     </span><span style="color:#FFCB6B;">failover@firewall.loc</span></span>
<span class="line"><span style="color:#A6ACCD;">     </span><span style="color:#FFCB6B;">sysadmin@firewall.loc</span></span>
<span class="line"><span style="color:#A6ACCD;">   }</span></span>
<span class="line"><span style="color:#A6ACCD;">   </span><span style="color:#FFCB6B;">notification_email_from</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">Alexandre.Cassen@firewall.loc</span></span>
<span class="line"><span style="color:#A6ACCD;">   </span><span style="color:#FFCB6B;">smtp_server</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">192.168.200.1</span></span>
<span class="line"><span style="color:#A6ACCD;">   </span><span style="color:#FFCB6B;">smtp_connect_timeout</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">30</span></span>
<span class="line"><span style="color:#A6ACCD;">   </span><span style="color:#FFCB6B;">router_id</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">LVS_DEVEL</span></span>
<span class="line"><span style="color:#A6ACCD;">   </span><span style="color:#FFCB6B;">vrrp_skip_check_adv_addr</span></span>
<span class="line"><span style="color:#A6ACCD;">   </span><span style="color:#FFCB6B;">vrrp_strict</span></span>
<span class="line"><span style="color:#A6ACCD;">   </span><span style="color:#FFCB6B;">vrrp_garp_interval</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">0</span></span>
<span class="line"><span style="color:#A6ACCD;">   </span><span style="color:#FFCB6B;">vrrp_gna_interval</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">0</span></span>
<span class="line"><span style="color:#A6ACCD;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FFCB6B;">vrrp_instance</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">VI_1</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#FFCB6B;">state</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">MASTER</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#FFCB6B;">interface</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">ens33</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#FFCB6B;">virtual_router_id</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">51</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#FFCB6B;">priority</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">100</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#FFCB6B;">advert_int</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">1</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#FFCB6B;">authentication</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#FFCB6B;">auth_type</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">PASS</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#FFCB6B;">auth_pass</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">1111</span></span>
<span class="line"><span style="color:#A6ACCD;">    }</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#FFCB6B;">virtual_ipaddress</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#FFCB6B;">192.168.1.100</span></span>
<span class="line"><span style="color:#A6ACCD;">    }</span></span>
<span class="line"><span style="color:#A6ACCD;">}</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#FFCB6B;">virtual_server</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">192.168.1.100</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">80</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">{#设置虚拟lvs服务，VIP</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">PORT</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#FFCB6B;">delay_loop</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">6</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#FFCB6B;">lb_algo</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">rr</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;font-style:italic;">#调度算法wrr</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#FFCB6B;">lb_kind</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">DR</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;font-style:italic;">#lvs的模式</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#FFCB6B;">nat_mask</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">255.255.255.0</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#FFCB6B;">persistence_timeout</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">50</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">同一个IP地址在50秒内lvs转发给同一个后端服务器</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#FFCB6B;">protocol</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">TCP</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#FFCB6B;">real_server</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">192.168.1.21</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">80</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">{#设置真实服务器的心跳机制</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">RID</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">PORT</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#FFCB6B;">weight</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">1</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;font-style:italic;">#权重</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#FFCB6B;">HTTP_GET</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">{#心跳检测的方式</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#FFCB6B;">url</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">              </span><span style="color:#FFCB6B;">path</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">/</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;font-style:italic;">#心跳检查的地址</span></span>
<span class="line"><span style="color:#A6ACCD;">              </span><span style="color:#FFCB6B;">status_code</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">200</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;font-style:italic;">#心跳检查返回的状态</span></span>
<span class="line"><span style="color:#A6ACCD;">            }</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#FFCB6B;">connect_timeout</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">2</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;font-style:italic;">#超时时间</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#FFCB6B;">nb_get_retry</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">3</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;font-style:italic;">#重复检查3次</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#FFCB6B;">delay_before_retry</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">1</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;font-style:italic;">#每隔1秒钟再次检查</span></span>
<span class="line"><span style="color:#A6ACCD;">        }</span></span>
<span class="line"><span style="color:#A6ACCD;">    }</span></span>
<span class="line"><span style="color:#A6ACCD;">	</span></span>
<span class="line"><span style="color:#A6ACCD;">	</span><span style="color:#FFCB6B;">real_server</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">192.168.1.22</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">80</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">{#设置真实服务器的心跳机制</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">RID</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">PORT</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#FFCB6B;">weight</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">1</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;font-style:italic;">#权重</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#FFCB6B;">HTTP_GET</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">{#心跳检测的方式</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#FFCB6B;">url</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">              </span><span style="color:#FFCB6B;">path</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">/</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;font-style:italic;">#心跳检查的地址</span></span>
<span class="line"><span style="color:#A6ACCD;">              </span><span style="color:#FFCB6B;">status_code</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">200</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;font-style:italic;">#心跳检查返回的状态</span></span>
<span class="line"><span style="color:#A6ACCD;">            }</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#FFCB6B;">connect_timeout</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">2</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;font-style:italic;">#超时时间</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#FFCB6B;">nb_get_retry</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">3</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;font-style:italic;">#重复检查3次</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#FFCB6B;">delay_before_retry</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">1</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;font-style:italic;">#每隔1秒钟再次检查</span></span>
<span class="line"><span style="color:#A6ACCD;">        }</span></span>
<span class="line"><span style="color:#A6ACCD;">    }</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span></span>
<span class="line"><span style="color:#A6ACCD;">}</span></span>
<span class="line"></span></code></pre></div><h4 id="dr2" tabindex="-1">DR2 <a class="header-anchor" href="#dr2" aria-hidden="true">#</a></h4><p>编辑配置文件</p><div class="language-sh"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#FFCB6B;">vim</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">/etc/keepalived/keepalived.conf</span></span>
<span class="line"></span></code></pre></div><p>keepalived.conf</p><div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#89DDFF;">!</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Configuration</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">File</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">for</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">keepalived</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FFCB6B;">global_defs</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">   </span><span style="color:#FFCB6B;">notification_email</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">     </span><span style="color:#FFCB6B;">acassen@firewall.loc</span></span>
<span class="line"><span style="color:#A6ACCD;">     </span><span style="color:#FFCB6B;">failover@firewall.loc</span></span>
<span class="line"><span style="color:#A6ACCD;">     </span><span style="color:#FFCB6B;">sysadmin@firewall.loc</span></span>
<span class="line"><span style="color:#A6ACCD;">   }</span></span>
<span class="line"><span style="color:#A6ACCD;">   </span><span style="color:#FFCB6B;">notification_email_from</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">Alexandre.Cassen@firewall.loc</span></span>
<span class="line"><span style="color:#A6ACCD;">   </span><span style="color:#FFCB6B;">smtp_server</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">192.168.200.1</span></span>
<span class="line"><span style="color:#A6ACCD;">   </span><span style="color:#FFCB6B;">smtp_connect_timeout</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">30</span></span>
<span class="line"><span style="color:#A6ACCD;">   </span><span style="color:#FFCB6B;">router_id</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">LVS_DEVEL</span></span>
<span class="line"><span style="color:#A6ACCD;">   </span><span style="color:#FFCB6B;">vrrp_skip_check_adv_addr</span></span>
<span class="line"><span style="color:#A6ACCD;">   </span><span style="color:#FFCB6B;">vrrp_strict</span></span>
<span class="line"><span style="color:#A6ACCD;">   </span><span style="color:#FFCB6B;">vrrp_garp_interval</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">0</span></span>
<span class="line"><span style="color:#A6ACCD;">   </span><span style="color:#FFCB6B;">vrrp_gna_interval</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">0</span></span>
<span class="line"><span style="color:#A6ACCD;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FFCB6B;">vrrp_instance</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">VI_1</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#FFCB6B;">state</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">BACKUP</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#FFCB6B;">interface</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">ens33</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#FFCB6B;">virtual_router_id</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">51</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#FFCB6B;">priority</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">50</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#FFCB6B;">advert_int</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">1</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#FFCB6B;">authentication</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#FFCB6B;">auth_type</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">PASS</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#FFCB6B;">auth_pass</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">1111</span></span>
<span class="line"><span style="color:#A6ACCD;">    }</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#FFCB6B;">virtual_ipaddress</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#FFCB6B;">192.168.1.100</span></span>
<span class="line"><span style="color:#A6ACCD;">    }</span></span>
<span class="line"><span style="color:#A6ACCD;">}</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#FFCB6B;">virtual_server</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">192.168.1.100</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">80</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">{#设置虚拟lvs服务，VIP</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">PORT</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#FFCB6B;">delay_loop</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">6</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#FFCB6B;">lb_algo</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">rr</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;font-style:italic;">#调度算法wrr</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#FFCB6B;">lb_kind</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">DR</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;font-style:italic;">#lvs的模式</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#FFCB6B;">nat_mask</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">255.255.255.0</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#FFCB6B;">persistence_timeout</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">50</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">同一个IP地址在50秒内lvs转发给同一个后端服务器</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#FFCB6B;">protocol</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">TCP</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#FFCB6B;">real_server</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">192.168.1.21</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">80</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">{#设置真实服务器的心跳机制</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">RID</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">PORT</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#FFCB6B;">weight</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">1</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;font-style:italic;">#权重</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#FFCB6B;">HTTP_GET</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">{#心跳检测的方式</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#FFCB6B;">url</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">              </span><span style="color:#FFCB6B;">path</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">/</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;font-style:italic;">#心跳检查的地址</span></span>
<span class="line"><span style="color:#A6ACCD;">              </span><span style="color:#FFCB6B;">status_code</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">200</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;font-style:italic;">#心跳检查返回的状态</span></span>
<span class="line"><span style="color:#A6ACCD;">            }</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#FFCB6B;">connect_timeout</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">2</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;font-style:italic;">#超时时间</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#FFCB6B;">nb_get_retry</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">3</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;font-style:italic;">#重复检查3次</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#FFCB6B;">delay_before_retry</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">1</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;font-style:italic;">#每隔1秒钟再次检查</span></span>
<span class="line"><span style="color:#A6ACCD;">        }</span></span>
<span class="line"><span style="color:#A6ACCD;">    }</span></span>
<span class="line"><span style="color:#A6ACCD;">	</span></span>
<span class="line"><span style="color:#A6ACCD;">	</span><span style="color:#FFCB6B;">real_server</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">192.168.1.22</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">80</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">{#设置真实服务器的心跳机制</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">RID</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">PORT</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#FFCB6B;">weight</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">1</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;font-style:italic;">#权重</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#FFCB6B;">HTTP_GET</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">{#心跳检测的方式</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#FFCB6B;">url</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">              </span><span style="color:#FFCB6B;">path</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">/</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;font-style:italic;">#心跳检查的地址</span></span>
<span class="line"><span style="color:#A6ACCD;">              </span><span style="color:#FFCB6B;">status_code</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">200</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;font-style:italic;">#心跳检查返回的状态</span></span>
<span class="line"><span style="color:#A6ACCD;">            }</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#FFCB6B;">connect_timeout</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">2</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;font-style:italic;">#超时时间</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#FFCB6B;">nb_get_retry</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">3</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;font-style:italic;">#重复检查3次</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#FFCB6B;">delay_before_retry</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">1</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;font-style:italic;">#每隔1秒钟再次检查</span></span>
<span class="line"><span style="color:#A6ACCD;">        }</span></span>
<span class="line"><span style="color:#A6ACCD;">    }</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span></span>
<span class="line"><span style="color:#A6ACCD;">}</span></span>
<span class="line"></span></code></pre></div><blockquote><ul><li>state BACKUP 备用节点</li><li>interface ens33 网卡名称</li><li>priority 50 权重</li></ul></blockquote><h3 id="rs上操作" tabindex="-1">RS上操作 <a class="header-anchor" href="#rs上操作" aria-hidden="true">#</a></h3><h4 id="安装软件" tabindex="-1">安装软件 <a class="header-anchor" href="#安装软件" aria-hidden="true">#</a></h4><div class="language-sh"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#FFCB6B;">yum</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">install</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">epel-release</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">-y</span></span>
<span class="line"></span></code></pre></div><h4 id="配置脚本" tabindex="-1">配置脚本 <a class="header-anchor" href="#配置脚本" aria-hidden="true">#</a></h4><p>编写脚本</p><div class="language-sh"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#FFCB6B;">vim</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">/usr/local/sbin/lvs_dr_rs.sh</span></span>
<span class="line"></span></code></pre></div><p>lvs_dr_rs.sh</p><div class="language-sh"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#676E95;font-style:italic;">#! /bin/bash</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">vip</span><span style="color:#89DDFF;">=</span><span style="color:#C3E88D;">192.168.1.100</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FFCB6B;">ifconfig</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">lo:</span><span style="color:#F78C6C;">0</span><span style="color:#A6ACCD;"> $vip </span><span style="color:#C3E88D;">broadcast</span><span style="color:#A6ACCD;"> $vip </span><span style="color:#C3E88D;">netmask</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">255.255.255.255</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">up</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FFCB6B;">route</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">add</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">-host</span><span style="color:#A6ACCD;"> $vip </span><span style="color:#C3E88D;">lo:</span><span style="color:#F78C6C;">0</span></span>
<span class="line"></span>
<span class="line"><span style="color:#82AAFF;">echo</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">1</span><span style="color:#89DDFF;">&quot;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&gt;</span><span style="color:#C3E88D;">/proc/sys/net/ipv4/conf/lo/arp_ignore</span></span>
<span class="line"></span>
<span class="line"><span style="color:#82AAFF;">echo</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">2</span><span style="color:#89DDFF;">&quot;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&gt;</span><span style="color:#C3E88D;">/proc/sys/net/ipv4/conf/lo/arp_announce</span></span>
<span class="line"></span>
<span class="line"><span style="color:#82AAFF;">echo</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">1</span><span style="color:#89DDFF;">&quot;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&gt;</span><span style="color:#C3E88D;">/proc/sys/net/ipv4/conf/all/arp_ignore</span></span>
<span class="line"></span>
<span class="line"><span style="color:#82AAFF;">echo</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">2</span><span style="color:#89DDFF;">&quot;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&gt;</span><span style="color:#C3E88D;">/proc/sys/net/ipv4/conf/all/arp_announce</span></span>
<span class="line"></span></code></pre></div><p>执行脚本</p><div class="language-sh"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#FFCB6B;">bash</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">/usr/local/sbin/lvs_dr_rs.sh</span></span>
<span class="line"></span></code></pre></div><h2 id="测试" tabindex="-1">测试 <a class="header-anchor" href="#测试" aria-hidden="true">#</a></h2><p>启动DR1和DR2的keepalived</p><div class="language-sh"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#FFCB6B;">service</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">keepalived</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">start</span></span>
<span class="line"></span></code></pre></div><p>打开<a href="http://192.168.1.100/" target="_blank" rel="noreferrer">http://192.168.1.100/</a></p><p>查看ip</p><div class="language-sh"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#FFCB6B;">ip</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">addr</span></span>
<span class="line"></span></code></pre></div><p>vip在DR1机子上。</p><p>手动停止keepalived</p><p>在DR2机子上输入</p><div class="language-sh"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#FFCB6B;">ip</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">addr</span></span>
<span class="line"></span></code></pre></div><p>vip跳到DR2机子上来了</p>`,41),e=[o];function t(c,C,r,y,A,i){return a(),n("div",null,e)}const d=s(p,[["render",t]]);export{F as __pageData,d as default};
