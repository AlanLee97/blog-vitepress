import{_ as s,o as a,c as n,b as e}from"./app.d2d47940.js";const g=JSON.parse('{"title":"Nginx+Keepalived实现高可用","description":"","frontmatter":{},"headers":[{"level":2,"title":"准备资源","slug":"准备资源","link":"#准备资源","children":[]},{"level":2,"title":"安装Keepalived","slug":"安装keepalived","link":"#安装keepalived","children":[]},{"level":2,"title":"配置Keepalived","slug":"配置keepalived","link":"#配置keepalived","children":[{"level":3,"title":"主节点配置","slug":"主节点配置","link":"#主节点配置","children":[]},{"level":3,"title":"备用节点配置","slug":"备用节点配置","link":"#备用节点配置","children":[]}]},{"level":2,"title":"配置主从切换","slug":"配置主从切换","link":"#配置主从切换","children":[]},{"level":2,"title":"访问测试","slug":"访问测试","link":"#访问测试","children":[]}],"relativePath":"knowledges/tech/tool/nginx/Nginx14 - Nginx+Keepalived实现高可用.md","lastUpdated":1678618356000}'),l={name:"knowledges/tech/tool/nginx/Nginx14 - Nginx+Keepalived实现高可用.md"},p=e(`<h1 id="nginx-keepalived实现高可用" tabindex="-1">Nginx+Keepalived实现高可用 <a class="header-anchor" href="#nginx-keepalived实现高可用" aria-hidden="true">#</a></h1><h2 id="准备资源" tabindex="-1">准备资源 <a class="header-anchor" href="#准备资源" aria-hidden="true">#</a></h2><p>2台Nginx，2台Tomcat</p><table><thead><tr><th>服务器</th><th>IP</th><th>端口</th><th>角色</th></tr></thead><tbody><tr><td>基于ip的虚拟主机</td><td>192.168.1.20</td><td>80</td><td>MASTER</td></tr><tr><td>Nginx - master - 2</td><td>192.168.1.200</td><td>80</td><td>BACKUP</td></tr><tr><td>Tomcat - 1</td><td>192.168.1.21</td><td>8080</td><td>WEB SERVER</td></tr><tr><td>Tomcat - 2</td><td>192.168.1.22</td><td>8080</td><td>WEB SERVER</td></tr></tbody></table><h2 id="安装keepalived" tabindex="-1">安装Keepalived <a class="header-anchor" href="#安装keepalived" aria-hidden="true">#</a></h2><p>在2台Nginx下都安装Keepalived</p><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#A6ACCD;">yum -y install keepalived</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span></code></pre></div><h2 id="配置keepalived" tabindex="-1">配置Keepalived <a class="header-anchor" href="#配置keepalived" aria-hidden="true">#</a></h2><p>主要配置4个地方</p><p><img src="https://gitee.com/AlanLee97/public-asset/raw/master/note_images/image-20200425095003540.png#alt=image-20200425095003540" alt=""></p><h3 id="主节点配置" tabindex="-1">主节点配置 <a class="header-anchor" href="#主节点配置" aria-hidden="true">#</a></h3><p>修改主Nginx服务器的/etc/keepalived/keepalived.conf文件，内容如下</p><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#A6ACCD;">! Configuration File for keepalived</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span>
<span class="line"><span style="color:#A6ACCD;">#全局配置</span></span>
<span class="line"><span style="color:#A6ACCD;">global_defs {</span></span>
<span class="line"><span style="color:#A6ACCD;">   notification_email {  #指定keepalived在发生切换时需要发送email到的对象，一行一个</span></span>
<span class="line"><span style="color:#A6ACCD;">     XXX@XXX.com</span></span>
<span class="line"><span style="color:#A6ACCD;">   }</span></span>
<span class="line"><span style="color:#A6ACCD;">   notification_email_from XXX@XXX.com  #指定发件人</span></span>
<span class="line"><span style="color:#A6ACCD;">   #smtp_server XXX.smtp.com                             #指定smtp服务器地址</span></span>
<span class="line"><span style="color:#A6ACCD;">   #smtp_connect_timeout 30                               #指定smtp连接超时时间</span></span>
<span class="line"><span style="color:#A6ACCD;">   router_id LVS_DEVEL                                    #运行keepalived机器的一个标识</span></span>
<span class="line"><span style="color:#A6ACCD;">}</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span>
<span class="line"><span style="color:#A6ACCD;">vrrp_instance VI_1 { </span></span>
<span class="line"><span style="color:#A6ACCD;">    state MASTER           #标示状态为MASTER 备份机为BACKUP</span></span>
<span class="line"><span style="color:#A6ACCD;">    interface ens33         #设置实例绑定的网卡</span></span>
<span class="line"><span style="color:#A6ACCD;">    virtual_router_id 51   #同一实例下virtual_router_id必须相同</span></span>
<span class="line"><span style="color:#A6ACCD;">    priority 100           #MASTER权重要高于BACKUP 比如BACKUP为99  </span></span>
<span class="line"><span style="color:#A6ACCD;">    advert_int 1           #MASTER与BACKUP负载均衡器之间同步检查的时间间隔，单位是秒</span></span>
<span class="line"><span style="color:#A6ACCD;">    authentication {       #设置认证</span></span>
<span class="line"><span style="color:#A6ACCD;">        auth_type PASS     #主从服务器验证方式</span></span>
<span class="line"><span style="color:#A6ACCD;">        auth_pass 8888</span></span>
<span class="line"><span style="color:#A6ACCD;">    }</span></span>
<span class="line"><span style="color:#A6ACCD;">    virtual_ipaddress {    #设置vip</span></span>
<span class="line"><span style="color:#A6ACCD;">        192.168.1.100       #可以多个虚拟IP，换行即可</span></span>
<span class="line"><span style="color:#A6ACCD;">    }</span></span>
<span class="line"><span style="color:#A6ACCD;">}</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span></code></pre></div><p>查看ip</p><p><img src="https://gitee.com/AlanLee97/public-asset/raw/master/note_images/image-20200425102447353.png#alt=image-20200425102447353" alt=""></p><h3 id="备用节点配置" tabindex="-1">备用节点配置 <a class="header-anchor" href="#备用节点配置" aria-hidden="true">#</a></h3><p>修改备用Nginx服务器的/etc/keepalived/keepalived.conf文件，内容如下</p><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#A6ACCD;">! Configuration File for keepalived</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span>
<span class="line"><span style="color:#A6ACCD;">#全局配置</span></span>
<span class="line"><span style="color:#A6ACCD;">global_defs {</span></span>
<span class="line"><span style="color:#A6ACCD;">   notification_email {  #指定keepalived在发生切换时需要发送email到的对象，一行一个</span></span>
<span class="line"><span style="color:#A6ACCD;">     XXX@XXX.com</span></span>
<span class="line"><span style="color:#A6ACCD;">   }</span></span>
<span class="line"><span style="color:#A6ACCD;">   notification_email_from XXX@XXX.com  #指定发件人</span></span>
<span class="line"><span style="color:#A6ACCD;">   #smtp_server XXX.smtp.com                             #指定smtp服务器地址</span></span>
<span class="line"><span style="color:#A6ACCD;">   #smtp_connect_timeout 30                               #指定smtp连接超时时间</span></span>
<span class="line"><span style="color:#A6ACCD;">   router_id LVS_DEVEL                                    #运行keepalived机器的一个标识</span></span>
<span class="line"><span style="color:#A6ACCD;">}</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span>
<span class="line"><span style="color:#A6ACCD;">vrrp_instance VI_1 { </span></span>
<span class="line"><span style="color:#A6ACCD;">    state BACKUP           #标示状态为MASTER 备份机为BACKUP</span></span>
<span class="line"><span style="color:#A6ACCD;">    interface ens33         #设置实例绑定的网卡</span></span>
<span class="line"><span style="color:#A6ACCD;">    virtual_router_id 51   #同一实例下virtual_router_id必须相同</span></span>
<span class="line"><span style="color:#A6ACCD;">    priority 99           #MASTER权重要高于BACKUP 比如BACKUP为99  </span></span>
<span class="line"><span style="color:#A6ACCD;">    advert_int 1           #MASTER与BACKUP负载均衡器之间同步检查的时间间隔，单位是秒</span></span>
<span class="line"><span style="color:#A6ACCD;">    authentication {       #设置认证</span></span>
<span class="line"><span style="color:#A6ACCD;">        auth_type PASS     #主从服务器验证方式</span></span>
<span class="line"><span style="color:#A6ACCD;">        auth_pass 8888</span></span>
<span class="line"><span style="color:#A6ACCD;">    }</span></span>
<span class="line"><span style="color:#A6ACCD;">    virtual_ipaddress {    #设置vip</span></span>
<span class="line"><span style="color:#A6ACCD;">        192.168.1.100       #可以多个虚拟IP，换行即可</span></span>
<span class="line"><span style="color:#A6ACCD;">    }</span></span>
<span class="line"><span style="color:#A6ACCD;">}</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span></code></pre></div><p>查看ip</p><p><img src="https://gitee.com/AlanLee97/public-asset/raw/master/note_images/20200425112737-652506.png#alt=image-20200425102552945" alt=""></p><p>只有当主节点的Keepalived停掉时，备用节点才会生成虚拟ip</p><p><img src="https://gitee.com/AlanLee97/public-asset/raw/master/note_images/20200425120320-891120.png#alt=image-20200425120316441" alt=""></p><h2 id="配置主从切换" tabindex="-1">配置主从切换 <a class="header-anchor" href="#配置主从切换" aria-hidden="true">#</a></h2><p>keepalived是通过检测keepalived进程是否存在判断服务器是否宕机，如果keepalived进程在但是nginx进程不在了那么keepalived是不会做主备切换，所以我们需要写个脚本来监控nginx进程是否存在，如果nginx不存在就将keepalived进程杀掉。</p><p>在主nginx上需要编写nginx进程检测脚本（check_nginx.sh），判断nginx进程是否存在，如果nginx不存在就将keepalived进程杀掉</p><p><strong>check_nginx.sh内容如下：</strong></p><div class="language-sh"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#676E95;font-style:italic;">#!/bin/bash</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># 如果进程中没有nginx则将keepalived进程kill掉</span></span>
<span class="line"><span style="color:#A6ACCD;">A</span><span style="color:#89DDFF;">=</span><span style="color:#89DDFF;">\`</span><span style="color:#FFCB6B;">ps</span><span style="color:#C3E88D;"> -C nginx --no-header </span><span style="color:#89DDFF;">|</span><span style="color:#FFCB6B;">wc</span><span style="color:#C3E88D;"> -l</span><span style="color:#89DDFF;">\`</span><span style="color:#A6ACCD;">      </span><span style="color:#676E95;font-style:italic;">## 查看是否有 nginx进程 把值赋给变量A </span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;"> $A </span><span style="color:#89DDFF;">-eq</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">0</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">];</span><span style="color:#89DDFF;font-style:italic;">then</span><span style="color:#A6ACCD;">                    </span><span style="color:#676E95;font-style:italic;">## 如果没有进程值得为 零</span></span>
<span class="line"><span style="color:#A6ACCD;">       </span><span style="color:#FFCB6B;">service</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">keepalived</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">stop</span><span style="color:#A6ACCD;">          </span><span style="color:#676E95;font-style:italic;">## 则结束 keepalived 进程</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">fi</span></span>
<span class="line"></span></code></pre></div><p><strong>添加客执行权限</strong></p><div class="language-sh"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#FFCB6B;">chmod</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">+x</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">/etc/keepalived/check_nginx.sh</span></span>
<span class="line"></span></code></pre></div><p><strong>修改主Nginx的配置</strong></p><p>添加如下两段代码</p><p>在vrrp_instance VI_1上面添加下面这段代码</p><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#A6ACCD;">vrrp_script check_nginx {</span></span>
<span class="line"><span style="color:#A6ACCD;">    script &quot;/etc/keepalived/check_nginx.sh&quot;         ##监控脚本</span></span>
<span class="line"><span style="color:#A6ACCD;">    interval 2                                      ##时间间隔，2秒</span></span>
<span class="line"><span style="color:#A6ACCD;">    weight 2                                        ##权重</span></span>
<span class="line"><span style="color:#A6ACCD;">}</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span></code></pre></div><p>在virtual_ipaddress上面添加下面这段代码</p><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#A6ACCD;">track_script {</span></span>
<span class="line"><span style="color:#A6ACCD;">	check_nginx        #监控脚本</span></span>
<span class="line"><span style="color:#A6ACCD;">}</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span></code></pre></div><h2 id="访问测试" tabindex="-1">访问测试 <a class="header-anchor" href="#访问测试" aria-hidden="true">#</a></h2><p>启动keepalived</p><div class="language-sh"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#FFCB6B;">service</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">keepalived</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">start</span></span>
<span class="line"></span></code></pre></div><p>为了区分主备Nginx，修改一下Nginx主页</p><p><img src="https://gitee.com/AlanLee97/public-asset/raw/master/note_images/20200425100407-304620.png#alt=image-20200425100407097" alt=""></p><p><img src="https://gitee.com/AlanLee97/public-asset/raw/master/note_images/20200425100502-880517.png#alt=image-20200425100502281" alt=""></p><p>浏览器访问虚拟ip，<a href="http://192.168.1.100/" target="_blank" rel="noreferrer">http://192.168.1.100/</a></p><p>首先进来的是主Nginx</p><p><img src="https://gitee.com/AlanLee97/public-asset/raw/master/note_images/image-20200425100638472.png#alt=image-20200425100638472" alt=""></p><p>当停掉主Nginx，会访问到备用Nginx</p><div class="language-sh"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#FFCB6B;">service</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">nginx</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">stop</span></span>
<span class="line"></span></code></pre></div><p>再次访问<a href="http://192.168.1.100/%EF%BC%8C%E8%BF%9B%E5%85%A5%E5%88%B0%E5%A4%87%E7%94%A8Nginx" target="_blank" rel="noreferrer">http://192.168.1.100/，进入到备用Nginx</a></p><p><img src="https://gitee.com/AlanLee97/public-asset/raw/master/note_images/image-20200425111547000.png#alt=image-20200425111547000" alt=""></p>`,48),t=[p];function i(o,c,r,C,d,A){return a(),n("div",null,t)}const h=s(l,[["render",i]]);export{g as __pageData,h as default};
