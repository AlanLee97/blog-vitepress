import{_ as s,o as a,c as n,b as l}from"./app.d2d47940.js";const d=JSON.parse('{"title":"MySQL主从配置与Mycat读写分离","description":"","frontmatter":{},"headers":[{"level":2,"title":"一、主数据库配置","slug":"一、主数据库配置","link":"#一、主数据库配置","children":[]},{"level":2,"title":"二、从数据库配置","slug":"二、从数据库配置","link":"#二、从数据库配置","children":[]},{"level":2,"title":"三、主从复制测试","slug":"三、主从复制测试","link":"#三、主从复制测试","children":[]},{"level":2,"title":"四、启用Mycat读写分离","slug":"四、启用mycat读写分离","link":"#四、启用mycat读写分离","children":[]},{"level":2,"title":"五、Mycat读写分离测试","slug":"五、mycat读写分离测试","link":"#五、mycat读写分离测试","children":[{"level":3,"title":"启用读写分离的查询","slug":"启用读写分离的查询","link":"#启用读写分离的查询","children":[]},{"level":3,"title":"不启用读写分离的查询","slug":"不启用读写分离的查询","link":"#不启用读写分离的查询","children":[]},{"level":3,"title":"统计","slug":"统计","link":"#统计","children":[]},{"level":3,"title":"总结","slug":"总结","link":"#总结","children":[]}]},{"level":2,"title":"六、遇到的问题","slug":"六、遇到的问题","link":"#六、遇到的问题","children":[{"level":3,"title":"问题1","slug":"问题1","link":"#问题1","children":[]},{"level":3,"title":"问题2","slug":"问题2","link":"#问题2","children":[]},{"level":3,"title":"原因","slug":"原因-1","link":"#原因-1","children":[]},{"level":3,"title":"解决","slug":"解决-1","link":"#解决-1","children":[]}]}],"relativePath":"knowledges/tech/database/mysql/MySQL主从配置与Mycat读写分离.md","lastUpdated":1678618356000}'),p={name:"knowledges/tech/database/mysql/MySQL主从配置与Mycat读写分离.md"},o=l(`<h1 id="mysql主从配置与mycat读写分离" tabindex="-1">MySQL主从配置与Mycat读写分离 <a class="header-anchor" href="#mysql主从配置与mycat读写分离" aria-hidden="true">#</a></h1><h2 id="一、主数据库配置" tabindex="-1">一、主数据库配置 <a class="header-anchor" href="#一、主数据库配置" aria-hidden="true">#</a></h2><ol><li></li></ol><p>编辑配置文件</p><p>添加如下内容</p><div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#FFCB6B;">server-id=1</span></span>
<span class="line"><span style="color:#FFCB6B;">binlog-do-db=master_db1</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;font-style:italic;">#备份的数据库</span></span>
<span class="line"><span style="color:#FFCB6B;">log-bin=mysql-bin</span></span>
<span class="line"><span style="color:#FFCB6B;">binlog-ignore-db=mysql</span></span>
<span class="line"></span></code></pre></div><p><img src="https://gitee.com/AlanLee97/public-asset/raw/master/note_images/image-20200523133136523.png#alt=image-20200523133136523" alt=""></p><ol start="2"><li></li></ol><p>重启mysql</p><ol start="3"><li></li></ol><p>创建一个允许从服务器来访问的用户(主服务器)：</p><div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#FFCB6B;">grant</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">replication</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">slave</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">on</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;">*</span><span style="color:#C3E88D;">.</span><span style="color:#A6ACCD;">*</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">to</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">root</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">@</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">%</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">identified</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">by</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">123456</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FFCB6B;">GRANT</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">FILE</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">ON</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;">*</span><span style="color:#C3E88D;">.</span><span style="color:#A6ACCD;">*</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">TO</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">root</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">@</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">%</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">IDENTIFIED</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">BY</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">123456</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FFCB6B;">FLUSH</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">PRIVILEGES</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span></code></pre></div><blockquote><p>grant replication slave on <em>.</em> to &#39;root&#39;@&#39;%&#39; identified by &#39;123456&#39;;</p></blockquote><blockquote><p>说明：</p></blockquote><blockquote><ul><li></li></ul></blockquote><p>root：Slave使用的账号</p><blockquote><ul><li></li></ul></blockquote><p>IDENTIFIED BY 123456：Slave使用的密码</p><blockquote><ul><li></li></ul></blockquote><p>%：Slave数据库IP</p><ol start="4"><li></li></ol><p>查看配置的信息</p><div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#FFCB6B;">show</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">master</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">status</span><span style="color:#A6ACCD;"> \\G</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span></code></pre></div><p>如图：</p><p><img src="https://gitee.com/AlanLee97/public-asset/raw/master/note_images/image-20200522155203831.png#alt=image-20200522155203831" alt=""></p><blockquote><p>记住 File和Position的值，后面会用到</p></blockquote><h2 id="二、从数据库配置" tabindex="-1">二、从数据库配置 <a class="header-anchor" href="#二、从数据库配置" aria-hidden="true">#</a></h2><ol><li>编辑配置文件my.cnf，在[mysqld]下面添加这段内容</li></ol><div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#FFCB6B;">log-bin=mysql-bin</span></span>
<span class="line"><span style="color:#FFCB6B;">server-id=2</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># 忽略日志的db</span></span>
<span class="line"><span style="color:#FFCB6B;">binlog-ignore-db=information_schema</span></span>
<span class="line"><span style="color:#FFCB6B;">binlog-ignore-db=cluster</span></span>
<span class="line"><span style="color:#FFCB6B;">binlog-ignore-db=mysql</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># 需要备份的db</span></span>
<span class="line"><span style="color:#FFCB6B;">replicate-do-db=master_db1</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># 忽略备份的db</span></span>
<span class="line"><span style="color:#FFCB6B;">replicate-ignore-db=mysql</span></span>
<span class="line"><span style="color:#FFCB6B;">log-slave-updates</span></span>
<span class="line"><span style="color:#FFCB6B;">slave-skip-errors=all</span></span>
<span class="line"><span style="color:#FFCB6B;">slave-net-timeout=60</span></span>
<span class="line"></span></code></pre></div><ol start="2"><li>关联Master信息</li></ol><div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#FFCB6B;">stop</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">slave</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FFCB6B;">CHANGE</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">MASTER</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">TO</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">MASTER_HOST=</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">192.168.1.20</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">,MASTER_USER=</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">root</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">,MASTER_PASSWORD=</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">123456</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">,MASTER_PORT=</span><span style="color:#F78C6C;">3306</span><span style="color:#C3E88D;">,MASTER_LOG_FILE=</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">mysql-bin.000001</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">,MASTER_CONNECT_RETRY=</span><span style="color:#F78C6C;">60</span><span style="color:#C3E88D;">,MASTER_LOG_POS=</span><span style="color:#F78C6C;">154</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FFCB6B;">start</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">slave</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span></code></pre></div><blockquote><p>这里的MASTER_LOG_POS=154的154就是配置主服务器的时候说要记住的那个，</p></blockquote><blockquote><p>MASTER_LOG_FILE的值就是之前的Position的值</p></blockquote><ol start="3"><li>查看状态</li></ol><div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#FFCB6B;">show</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">slave</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">status</span><span style="color:#A6ACCD;"> \\G</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span></code></pre></div><p><img src="https://gitee.com/AlanLee97/public-asset/raw/master/note_images/image-20200522170042277.png#alt=image-20200522170042277" alt=""></p><blockquote><p>只有Slave_IO_Running与Slave_SQL_Running都为Yes才配置成功。</p></blockquote><h2 id="三、主从复制测试" tabindex="-1">三、主从复制测试 <a class="header-anchor" href="#三、主从复制测试" aria-hidden="true">#</a></h2><ol><li>在从服务器中创建数据库master_db1</li></ol><p><img src="https://gitee.com/AlanLee97/public-asset/raw/master/note_images/image-20200523131328951.png#alt=image-20200523131328951" alt=""></p><ol start="2"><li>在主MySQL服务器创建test表，测试结果是从MySQL的服务器会自动复制主MySQL服务器的test表。</li><li>添加500w条数据进行测试，可以使用jdbc插入，也可以使用dataFactory。（可以先手动插入一条数据查看效果）<img src="https://gitee.com/AlanLee97/public-asset/raw/master/note_images/image-20200603111431707.png#alt=image-20200603111431707" alt=""></li></ol><p><img src="https://gitee.com/AlanLee97/public-asset/raw/master/note_images/image-20200603111537557.png#alt=image-20200603111537557" alt=""></p><h2 id="四、启用mycat读写分离" tabindex="-1">四、启用Mycat读写分离 <a class="header-anchor" href="#四、启用mycat读写分离" aria-hidden="true">#</a></h2><table><thead><tr><th></th><th>主机名</th><th>IP和端口</th><th>操作</th><th>引擎</th></tr></thead><tbody><tr><td>主MySQL服务器</td><td>master</td><td>192.168.1.20:3306</td><td>写</td><td>InnoDB</td></tr><tr><td>从MySQL服务器</td><td>node-1</td><td>192.168.1.21:3306</td><td>读</td><td>MyISAM</td></tr></tbody></table><ol><li></li></ol><p>修改从数据库的表</p><p>将表的引擎改为<code>MyISAM</code></p><p><img src="https://gitee.com/AlanLee97/public-asset/raw/master/note_images/image-20200523135553033.png#alt=image-20200523135553033" alt=""></p><ol start="2"><li></li></ol><p>配置mycat读写分离</p><p>编辑schema.xml文件</p><div class="language-xml"><button title="Copy Code" class="copy"></button><span class="lang">xml</span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#A6ACCD;">&lt;？xml version=&quot;1.0&quot;?&gt;</span></span>
<span class="line"><span style="color:#89DDFF;">&lt;!</span><span style="color:#F78C6C;">DOCTYPE</span><span style="color:#89DDFF;"> </span><span style="color:#A6ACCD;">mycat:schema</span><span style="color:#89DDFF;"> SYSTEM &quot;schema.dtd&quot;&gt;</span></span>
<span class="line"><span style="color:#89DDFF;">&lt;</span><span style="color:#F07178;">mycat</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;">schema</span><span style="color:#89DDFF;"> </span><span style="color:#C792EA;">xmlns</span><span style="color:#89DDFF;">:</span><span style="color:#C792EA;">mycat</span><span style="color:#89DDFF;">=</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">http://org.opencloudb/</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">	</span><span style="color:#89DDFF;">&lt;</span><span style="color:#F07178;">schema</span><span style="color:#89DDFF;"> </span><span style="color:#C792EA;">name</span><span style="color:#89DDFF;">=</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">zdxh</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;"> </span><span style="color:#C792EA;">checkSQLschema</span><span style="color:#89DDFF;">=</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">false</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;"> </span><span style="color:#C792EA;">sqlMaxLimit</span><span style="color:#89DDFF;">=</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">100</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">		</span><span style="color:#676E95;font-style:italic;">&lt;!-- 测试读写分离 --&gt;</span></span>
<span class="line"><span style="color:#A6ACCD;">		</span><span style="color:#89DDFF;">&lt;</span><span style="color:#F07178;">table</span><span style="color:#89DDFF;"> </span><span style="color:#C792EA;">name</span><span style="color:#89DDFF;">=</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">test</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;"> </span><span style="color:#C792EA;">primaryKey</span><span style="color:#89DDFF;">=</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">ID</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;"> </span><span style="color:#C792EA;">dataNode</span><span style="color:#89DDFF;">=</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">dn4</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;"> /&gt;</span></span>
<span class="line"><span style="color:#A6ACCD;">	</span><span style="color:#89DDFF;">&lt;/</span><span style="color:#F07178;">schema</span><span style="color:#89DDFF;">&gt;</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">	</span><span style="color:#676E95;font-style:italic;">&lt;!-- 测试读写分离 --&gt;</span></span>
<span class="line"><span style="color:#A6ACCD;">	</span><span style="color:#89DDFF;">&lt;</span><span style="color:#F07178;">dataNode</span><span style="color:#89DDFF;"> </span><span style="color:#C792EA;">name</span><span style="color:#89DDFF;">=</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">dn4</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;"> </span><span style="color:#C792EA;">dataHost</span><span style="color:#89DDFF;">=</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">local-master-rw</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;"> </span><span style="color:#C792EA;">database</span><span style="color:#89DDFF;">=</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">master_db1</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;"> /&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">	</span></span>
<span class="line"><span style="color:#A6ACCD;">	</span><span style="color:#676E95;font-style:italic;">&lt;!-- 测试读写分离 --&gt;</span></span>
<span class="line"><span style="color:#A6ACCD;">	</span><span style="color:#89DDFF;">&lt;</span><span style="color:#F07178;">dataHost</span><span style="color:#89DDFF;"> </span><span style="color:#C792EA;">name</span><span style="color:#89DDFF;">=</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">local-master-rw</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;"> </span><span style="color:#C792EA;">maxCon</span><span style="color:#89DDFF;">=</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">1000</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;"> </span><span style="color:#C792EA;">minCon</span><span style="color:#89DDFF;">=</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">10</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;"> </span><span style="color:#C792EA;">balance</span><span style="color:#89DDFF;">=</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">1</span><span style="color:#89DDFF;">&quot;</span></span>
<span class="line"><span style="color:#89DDFF;">		</span><span style="color:#C792EA;">writeType</span><span style="color:#89DDFF;">=</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">0</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;"> </span><span style="color:#C792EA;">dbType</span><span style="color:#89DDFF;">=</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">mysql</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;"> </span><span style="color:#C792EA;">dbDriver</span><span style="color:#89DDFF;">=</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">native</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;"> </span><span style="color:#C792EA;">switchType</span><span style="color:#89DDFF;">=</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">1</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">  </span><span style="color:#C792EA;">slaveThreshold</span><span style="color:#89DDFF;">=</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">100</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">&gt;</span></span>
<span class="line"><span style="color:#A6ACCD;">		</span><span style="color:#89DDFF;">&lt;</span><span style="color:#F07178;">heartbeat</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;">select user()</span><span style="color:#89DDFF;">&lt;/</span><span style="color:#F07178;">heartbeat</span><span style="color:#89DDFF;">&gt;</span></span>
<span class="line"><span style="color:#A6ACCD;">		</span><span style="color:#676E95;font-style:italic;">&lt;!-- 写入配置--&gt;</span></span>
<span class="line"><span style="color:#A6ACCD;">		</span><span style="color:#89DDFF;">&lt;</span><span style="color:#F07178;">writeHost</span><span style="color:#89DDFF;"> </span><span style="color:#C792EA;">host</span><span style="color:#89DDFF;">=</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">hostM4</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;"> </span><span style="color:#C792EA;">url</span><span style="color:#89DDFF;">=</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">192.168.1.20:3306</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;"> </span></span>
<span class="line"><span style="color:#89DDFF;">                   </span><span style="color:#C792EA;">user</span><span style="color:#89DDFF;">=</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">root</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;"> </span><span style="color:#C792EA;">password</span><span style="color:#89DDFF;">=</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">123456</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">&gt;</span></span>
<span class="line"><span style="color:#A6ACCD;">			</span><span style="color:#676E95;font-style:italic;">&lt;!-- 添加只读库配置--&gt;</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;">&lt;</span><span style="color:#F07178;">readHost</span><span style="color:#89DDFF;"> </span><span style="color:#C792EA;">host</span><span style="color:#89DDFF;">=</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">hostS1</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;"> </span><span style="color:#C792EA;">url</span><span style="color:#89DDFF;">=</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">192.168.1.21:3306</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;"> </span></span>
<span class="line"><span style="color:#89DDFF;">                      </span><span style="color:#C792EA;">user</span><span style="color:#89DDFF;">=</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">root</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;"> </span><span style="color:#C792EA;">password</span><span style="color:#89DDFF;">=</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">123456</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;"> /&gt;</span></span>
<span class="line"><span style="color:#A6ACCD;">		</span><span style="color:#89DDFF;">&lt;/</span><span style="color:#F07178;">writeHost</span><span style="color:#89DDFF;">&gt;</span></span>
<span class="line"><span style="color:#A6ACCD;">	</span><span style="color:#89DDFF;">&lt;/</span><span style="color:#F07178;">dataHost</span><span style="color:#89DDFF;">&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">&lt;/</span><span style="color:#F07178;">mycat</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;">schema</span><span style="color:#89DDFF;">&gt;</span></span>
<span class="line"></span></code></pre></div><p><img src="https://gitee.com/AlanLee97/public-asset/raw/master/note_images/image-20200523145846248.png#alt=image-20200523145846248" alt=""></p><h2 id="五、mycat读写分离测试" tabindex="-1">五、Mycat读写分离测试 <a class="header-anchor" href="#五、mycat读写分离测试" aria-hidden="true">#</a></h2><p>测试分为启用读写分离测试和不启用读写分离的情况赖测试</p><h3 id="启用读写分离的查询" tabindex="-1">启用读写分离的查询 <a class="header-anchor" href="#启用读写分离的查询" aria-hidden="true">#</a></h3><p>配置schema.xml</p><p><img src="https://gitee.com/AlanLee97/public-asset/raw/master/note_images/image-20200603092525583.png#alt=image-20200603092525583" alt=""></p><p>在mycat中查询</p><p><strong>count关键字查询</strong></p><div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#89DDFF;font-style:italic;">select</span><span style="color:#A6ACCD;"> count(id) from test</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span></code></pre></div><p><img src="https://gitee.com/AlanLee97/public-asset/raw/master/note_images/image-20200603093857376.png#alt=image-20200603093857376" alt=""></p><p><strong>like关键字查询</strong></p><div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#89DDFF;font-style:italic;">select</span><span style="color:#A6ACCD;"> * from test where name like </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">%alanlee%</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span></code></pre></div><p><img src="https://gitee.com/AlanLee97/public-asset/raw/master/note_images/image-20200603094541570.png#alt=image-20200603094541570" alt=""></p><p><strong>=查询</strong></p><div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#89DDFF;font-style:italic;">select</span><span style="color:#A6ACCD;"> * from test where name = </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">alanlee</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span></code></pre></div><p><img src="https://gitee.com/AlanLee97/public-asset/raw/master/note_images/image-20200603094709481.png#alt=image-20200603094709481" alt=""></p><p><strong>insert</strong></p><div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#FFCB6B;">insert</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">into</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">test</span><span style="color:#89DDFF;">(</span><span style="color:#FFCB6B;">name</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">values</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">libuguan</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">);</span></span>
<span class="line"></span></code></pre></div><p><img src="https://gitee.com/AlanLee97/public-asset/raw/master/note_images/image-20200603095335013.png#alt=image-20200603095335013" alt=""></p><p><strong>update</strong></p><div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#FFCB6B;">update</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">test</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">set</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">name</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">libuguan-007</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">where</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">name</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">libuguan</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span></code></pre></div><p><img src="https://gitee.com/AlanLee97/public-asset/raw/master/note_images/image-20200603095728778.png#alt=image-20200603095728778" alt=""></p><p><strong>delete</strong></p><div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#FFCB6B;">delete</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">from</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">test</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">where</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">name</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">libuguan-007</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span></code></pre></div><p><img src="https://gitee.com/AlanLee97/public-asset/raw/master/note_images/image-20200603100214050.png#alt=image-20200603100214050" alt=""></p><h3 id="不启用读写分离的查询" tabindex="-1">不启用读写分离的查询 <a class="header-anchor" href="#不启用读写分离的查询" aria-hidden="true">#</a></h3><p>配置schema.xml</p><p><img src="https://gitee.com/AlanLee97/public-asset/raw/master/note_images/image-20200529152232726.png#alt=image-20200529152232726" alt=""></p><p>在mycat中查询</p><p><strong>count关键字查询</strong></p><div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#89DDFF;font-style:italic;">select</span><span style="color:#A6ACCD;"> count(*) from test</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span></code></pre></div><p><img src="https://gitee.com/AlanLee97/public-asset/raw/master/note_images/image-20200529151832264.png#alt=image-20200529151832264" alt=""></p><p><strong>like关键字查询</strong></p><div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#89DDFF;font-style:italic;">select</span><span style="color:#A6ACCD;"> * from test where name like </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">%alanlee%</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span></code></pre></div><p><img src="https://gitee.com/AlanLee97/public-asset/raw/master/note_images/image-20200529153145449.png#alt=image-20200529153145449" alt=""></p><p><strong>=查询</strong></p><div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#89DDFF;font-style:italic;">select</span><span style="color:#A6ACCD;"> * from test where name = </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">alanlee</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span></code></pre></div><p><img src="https://gitee.com/AlanLee97/public-asset/raw/master/note_images/image-20200529153440308.png#alt=image-20200529153440308" alt=""></p><p><strong>insert</strong></p><div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#FFCB6B;">insert</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">into</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">test</span><span style="color:#89DDFF;">(</span><span style="color:#FFCB6B;">name</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">values</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">libuguan-01</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">);</span></span>
<span class="line"></span></code></pre></div><p><img src="https://gitee.com/AlanLee97/public-asset/raw/master/note_images/image-20200603104934708.png#alt=image-20200603104934708" alt=""></p><p><strong>update</strong></p><div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#FFCB6B;">update</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">test</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">set</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">name</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">libuguan-02</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">where</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">name</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">libuguan-01</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span></code></pre></div><p><img src="https://gitee.com/AlanLee97/public-asset/raw/master/note_images/image-20200603105102926.png#alt=image-20200603105102926" alt=""></p><p><strong>delete</strong></p><div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#FFCB6B;">delete</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">from</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">test</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">where</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">name</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">libuguan-02</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span></code></pre></div><p><img src="https://gitee.com/AlanLee97/public-asset/raw/master/note_images/image-20200603105351203.png#alt=image-20200603105351203" alt=""></p><h3 id="统计" tabindex="-1">统计 <a class="header-anchor" href="#统计" aria-hidden="true">#</a></h3><table><thead><tr><th>Sql语句</th><th>启用读写分离机制（读库使用MyISAM）</th><th>取消读写分离机制(读使用的是Innodb)</th></tr></thead><tbody><tr><td>count</td><td>0.00秒</td><td>1.68秒</td></tr><tr><td>like</td><td>2.36秒</td><td>3.01秒</td></tr><tr><td>=</td><td>0.92秒</td><td>1.30秒</td></tr><tr><td>insert</td><td>0.11秒</td><td>0.05秒</td></tr><tr><td>update</td><td>3.27秒</td><td>3.02秒</td></tr><tr><td>delete</td><td>2.93秒</td><td>3.31秒</td></tr></tbody></table><p><img src="https://gitee.com/AlanLee97/public-asset/raw/master/note_images/image-20200603110848207.png#alt=image-20200603110848207" alt=""></p><h3 id="总结" tabindex="-1">总结 <a class="header-anchor" href="#总结" aria-hidden="true">#</a></h3><p>**启用mycat读写分离，查询操作的速度比不启用读写分离快很多。**原因是查询时使用的是MyISAM引擎。而插入、更新、删除的操作基本上没有变化，因为执行这3个操作时都是使用的InnoDB引擎。</p><h2 id="六、遇到的问题" tabindex="-1">六、遇到的问题 <a class="header-anchor" href="#六、遇到的问题" aria-hidden="true">#</a></h2><h3 id="问题1" tabindex="-1">问题1 <a class="header-anchor" href="#问题1" aria-hidden="true">#</a></h3><p>[ERROR] unknown variable &#39;master-host=192.168.1.20&#39;</p><p><img src="https://gitee.com/AlanLee97/public-asset/raw/master/note_images/image-20200522162243354.png#alt=image-20200522162243354" alt=""></p><h4 id="原因" tabindex="-1">原因 <a class="header-anchor" href="#原因" aria-hidden="true">#</a></h4><p>MySQL5.6和之后的版本没有master-host参数了</p><h4 id="解决" tabindex="-1">解决 <a class="header-anchor" href="#解决" aria-hidden="true">#</a></h4><p>解决方案：</p><ol><li>在my.cnf文件的[mysqld]下面添加以下配置</li></ol><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#A6ACCD;">log-bin=mysql-bin</span></span>
<span class="line"><span style="color:#A6ACCD;">server-id=2</span></span>
<span class="line"><span style="color:#A6ACCD;"># 忽略日志的db</span></span>
<span class="line"><span style="color:#A6ACCD;">binlog-ignore-db=information_schema</span></span>
<span class="line"><span style="color:#A6ACCD;">binlog-ignore-db=cluster</span></span>
<span class="line"><span style="color:#A6ACCD;">binlog-ignore-db=mysql</span></span>
<span class="line"><span style="color:#A6ACCD;"># 需要备份的db</span></span>
<span class="line"><span style="color:#A6ACCD;">replicate-do-db=master_db</span></span>
<span class="line"><span style="color:#A6ACCD;"># 忽略备份的db</span></span>
<span class="line"><span style="color:#A6ACCD;">replicate-ignore-db=mysql</span></span>
<span class="line"><span style="color:#A6ACCD;">log-slave-updates</span></span>
<span class="line"><span style="color:#A6ACCD;">slave-skip-errors=all</span></span>
<span class="line"><span style="color:#A6ACCD;">slave-net-timeout=60</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span></code></pre></div><p><img src="https://gitee.com/AlanLee97/public-asset/raw/master/note_images/image-20200522165424009.png#alt=image-20200522165424009" alt=""></p><ol start="2"><li></li></ol><p>重启mysql</p><ol start="3"><li></li></ol><p>命令行输入</p><div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#FFCB6B;">CHANGE</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">MASTER</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">TO</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">MASTER_HOST=</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">192.168.1.20</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">,MASTER_USER=</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">root</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">,MASTER_PASSWORD=</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">123456</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">,MASTER_PORT=</span><span style="color:#F78C6C;">3306</span><span style="color:#C3E88D;">,MASTER_LOG_FILE=</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">mysql-bin.000001</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">,MASTER_CONNECT_RETRY=</span><span style="color:#F78C6C;">60</span><span style="color:#C3E88D;">,MASTER_LOG_POS=</span><span style="color:#F78C6C;">154</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span></code></pre></div><blockquote><p>需根据自己的机子修改参数值</p></blockquote><blockquote><ul><li>MASTER_HOST</li><li>MASTER_LOG_FILE</li><li>MASTER_LOG_POS</li></ul></blockquote><p><img src="https://gitee.com/AlanLee97/public-asset/raw/master/note_images/image-20200522164835461.png#alt=image-20200522164835461" alt=""></p><h3 id="问题2" tabindex="-1">问题2 <a class="header-anchor" href="#问题2" aria-hidden="true">#</a></h3><p>配置好了主从服务器之后，主服务器创建表后，从服务器不会复制</p><h3 id="原因-1" tabindex="-1">原因 <a class="header-anchor" href="#原因-1" aria-hidden="true">#</a></h3><p>没有赋予Slave机器有File权限，没有刷新权限。</p><h3 id="解决-1" tabindex="-1">解决 <a class="header-anchor" href="#解决-1" aria-hidden="true">#</a></h3><p>在主MySQL服务器中命令行执行</p><div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki material-theme-palenight" tabindex="0"><code><span class="line"><span style="color:#676E95;font-style:italic;"># 赋予Slave机器有File权限</span></span>
<span class="line"><span style="color:#FFCB6B;">GRANT</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">FILE</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">ON</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;">*</span><span style="color:#C3E88D;">.</span><span style="color:#A6ACCD;">*</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">TO</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">root</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">@</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">%</span><span style="color:#89DDFF;">&#39;</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">IDENTIFIED</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">BY</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">123456</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># 刷新权限</span></span>
<span class="line"><span style="color:#FFCB6B;">FLUSH</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">PRIVILEGES</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span></code></pre></div><p>重启主MySQL服务器</p><blockquote><p>还要检查其他的配置是否准确，例如MASTER_HOST，MASTER_LOG_FILE，MASTER_LOG_POS的参数值等等。</p></blockquote>`,132),e=[o];function t(c,r,D,i,y,F){return a(),n("div",null,e)}const g=s(p,[["render",t]]);export{d as __pageData,g as default};
